# 洪涝灾害图像识别与救援建议系统——实施方式补充与附图思路（节选）

## 3. 发明内容

### 3.1 方法概述
系统遵循“预处理—感知—提示构建—多模态推理—结构化输出”的主流程。其中特征化处理与指令构造在同一提示链路中闭环，保证空间信息与语义理解的一致性。模型在保持高分辨率感知的同时，支持多轮追问与救援指挥级的长文本生成。

### 3.2 关键功能节点
- **自适应预处理**：对任意尺寸的灾害图像进行自动填充、居中裁剪和固定步长分块，兼顾宽高比与局部细节，避免远距离航拍或倾斜视角导致的目标失真。
- **实例检测与坐标归一化**：利用预训练YOLO模型输出被淹目标的边界框集合，并依据原始分辨率进行归一化，形成位置可验证的提示文本。
- **对话模板与历史上下文拼接**：通过多模态占位符（如`<image>`、`<im_start>`、`<im_end>`）与轮次分隔符，将检测结果、用户提问和历史回答整合，形成救援场景的连续对话输入。
- **多模态推理与救援建议生成**：大模型在灾害知识约束下输出整体风险、重点区域、人员撤离路径及物资调度建议，并支持持续追问以完善决策。

## 4. 具体实施方式（结合代码与流程）

### 4.1 处理与推理流程
1. **加载模型与处理器**（`demo.py`）：
   - 调用`load_pretrained_model`加载多模态大语言模型、图像处理器与分词器，完成权重与设备初始化。
   - 通过命令行参数接收图像路径和救援问题，将其组织为包含图像token的对话输入。
2. **图像自适应预处理**（`llmark/mm_utils.py`）：
   - `expand2square`和相关函数对输入图像进行自动填充、居中裁剪，生成适合模型的正方形视野。
   - `select_best_resolution`与`get_image_grid`根据候选分辨率和步长拆分超大图，确保显存可控且细节保留。
3. **实例检测与空间提示生成**（`llmark/get_box.py`）：
   - 调用YOLO推理接口输出各类淹没目标的边界框，按原图尺寸归一化到`[x1,y1,x2,y2]`格式。
   - 将坐标写回用户问题或默认提示，形成带空间先验的查询，未提供位置描述时自动补全。
4. **对话模板构建与历史上下文管理**（`llmark/conversation.py`）：
   - 依据模型类型选择合适的图像token包装与轮次分隔符，拼接用户提问、检测结果和历史答案。
   - 支持`<im_start>`/`<im_end>`或`<image>`等占位符，保证多模态编码与文本对齐。
5. **多模态推理与结果生成**（`demo.py`）：
   - 将编码后的图像tensor与文本提示输入大模型，生成包含风险等级、重点区域、撤离路线、物资与通信建议的结构化长文本。
   - 支持将模型输出与用户新指令再次拼接，形成多轮追问，提升救援决策的连贯性。
6. **结果呈现与落地**：
   - 将文本结果与可视化检测框一并输出，可嵌入应急指挥平台、无人机地面站或移动端界面，实现快速调度与复核。

### 4.2 参数与部署要点
- **显存与分辨率权衡**：通过分块切片与分辨率筛选，在显存受限设备上保持关键细节，提升推理稳定性。
- **模型替换与可扩展性**：YOLO和大模型可替换为更高精度版本，保持提示融合机制不变；支持GPU/CPU或本地/云端部署。
- **可靠性与追溯**：保存检测可视化与生成日志，便于救援后验和模型迭代；对重要提示添加空间先验以降低幻觉。

### 4.3 附图完成思路
- **系统框架示意图**：展示图像输入→预处理与分块→实例检测→提示构建→多模态推理→终端展示的模块箭头关系，突出空间提示在提示构建中的插入节点。
- **核心流程时序图**：以序列方式标注图像处理、检测、提示生成、推理与输出的调用顺序，可包含主要函数名（如`get_box`、`build_prompt`、`load_pretrained_model`）。
- **界面与结果示例**：展示带边界框的灾害图像及对应的救援建议文本，标注风险等级、关键坐标与建议列表，说明可视化与文本的对齐关系。
- **部署拓扑草图（可选）**：表现无人机/摄像头→边缘节点推理→指挥中心的网络连接，突出离线/在线双模支持。
