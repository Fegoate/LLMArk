# 洪涝灾害图像智能识别与救援建议生成系统专利交底书（扩展版节选）

## 3. 发明内容

### 3.1 总体方案
本发明提出一种“感知—理解—决策”一体化的洪涝灾害智能识别与救援建议生成方案。系统首先在前端对高分辨率灾害图片进行适配式预处理，自动完成填充、裁剪与分块，确保不同尺寸与视角的图像都能被稳定接入。随后，利用预训练的YOLO实例检测模型获取被淹目标的归一化边界框，并将位置坐标回写到后续提示语中，为大模型提供空间先验。经由这一融合了视觉位置编码的提示，图像与文本被联合送入多模态大语言模型进行推理，模型在灾害知识约束下输出整体风险等级、区域优先级、救援路径和物资调度建议。若救援人员继续提问，系统会保留上下文，实现多轮、可追溯的交互式决策支持。

### 3.2 核心创新点
1. **边界框-语言融合提示**：在实例检测后自动将归一化坐标插入提示语，形成“at position [x1,y1,x2,y2]”或中文位置描述，使多模态大模型对答复中的位置描述具有可验证依据，降低幻觉风险。
2. **高分辨率自适应预处理**：通过自动填充、居中裁剪和切片策略，兼顾宽高比与特征密度。该策略支持无人机、遥感卫星及移动端照片等不同分辨率输入，并可按候选分辨率筛选平衡计算成本与识别精度。
3. **领域化对话模板**：设计包含图像token占位符与多轮分隔符的救援场景对话模板，将检测结果、历史问答与用户新指令串接，使指挥员能够以自然语言提出风险询问、路径规划、物资需求等多种任务，提升交互效率。

### 3.3 主要技术方案
#### 3.3.1 图像预处理与分辨率匹配
系统在接收任意尺寸的灾害图片后，先通过自动填充保持主体不被裁切，再进行居中裁剪和网格化切片，对超高分辨率图像按固定步长拆分。对于不同硬件资源条件，预处理模块按照候选分辨率清单筛选最优分辨率，既保留关键水位、道路淹没等细节，又控制推理耗时。

#### 3.3.2 实例感知与空间提示生成
预处理后的图像输入YOLO模型，生成被淹目标（人员、车辆、建筑物等）的边界框集合。系统将边框坐标按原始尺寸归一化，写入到用户问题或默认提示中，形成带空间标签的问句。若用户未提供具体区域描述，系统自动补全“在坐标[x1,y1,x2,y2]”的提示，并保存检测可视化结果便于事后核查。

#### 3.3.3 多模态大模型推理与对话
构建含图像token（如`<image>`、`<im_start>`、`<im_end>`）的对话模板，将视觉特征与文本提示一起输入多模态大语言模型。模型输出的文本包含总体风险评估、局部隐患、撤离路线与物资调度建议，并支持延续历史上下文的多轮追问。每轮生成的答案会与用户指令共同组成新的对话上下文，保证救援决策的连贯性与可追踪性。

#### 3.3.4 输出与应用
系统最终向终端输出结构化文本，包括风险等级、关键目标位置、优先救援清单和行动建议。结果可直接集成到应急指挥平台、无人机地面站或移动端应用，指挥员可据此下发调度指令，实现现场快速决策。

## 4. 具体实施方式（结合代码）
1. **模型加载与推理**：在`demo.py`中，通过`load_pretrained_model`加载多模态大语言模型与图像处理器，接收用户问题与图片后完成推理并生成救援文本。
2. **边界框生成**：`llmark/get_box.py`封装YOLO推理流程，输出归一化边界框，并自动将坐标写回提示语，为大模型提供空间先验信息。
3. **对话模板与图像token处理**：`llmark/conversation.py`定义多轮对话模板及图像token处理逻辑，负责将图像占位符与历史对话拼接，保障模型正确解析多模态输入。
4. **高分辨率处理工具**：`llmark/mm_utils.py`提供自动填充、分块提取、分辨率候选筛选等函数，确保大模型在大尺寸图像上保持有效感知，同时平衡显存占用与处理时间。
5. **终端交互流程**：用户通过自然语言提出“整体洪涝风险及建议”等问题，系统依次执行预处理、检测补位、对话模板构建、多模态推理与答案生成，并将结构化建议返回终端，供救援人员直接采纳或二次询问。
