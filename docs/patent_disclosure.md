# 洪涝灾害图像智能识别与救援建议生成系统专利交底书

## 1. 技术领域
本发明涉及计算机视觉与大模型应用技术，具体是一种结合多模态大语言模型与实例检测网络，对洪涝灾害场景图片进行风险识别、定位标注，并生成救援决策文本的智能系统。

## 2. 背景技术
洪涝灾害发生后，救援人员需迅速获知被困人员、道路淹没、基础设施受损等信息。现有方案多依赖人工标注或单一视觉模型，缺乏对复杂场景的多轮理解与文字化指挥能力，且难以将目标检测结果与大语言模型推理闭环融合，导致响应慢、建议泛化不足。

## 3. 发明内容
### 3.1 总体方案
本发明提供一种“感知-理解-决策”一体化方法：
1. 通过高分辨率图像预处理与自动分块，保证模型在不同尺度下的感知质量；
2. 基于预训练YOLO实例感知模型获取被淹目标的归一化边界框并写回提示词；
3. 将含位置编码的图像与提示发送至多模态大语言模型，联合视觉特征与灾害领域知识输出风险等级、救援优先级及行动建议；
4. 支持多轮对话查询，实现实时、可追溯的救援交互。

### 3.2 核心创新点
- **边界框-语言融合提示**：从图像检测出归一化坐标后动态插入到提示文本中，为大模型提供空间定位先验，提高问答与指挥的可验证性。
- **高分辨率自适应预处理**：通过自动填充、居中裁剪与分块，兼顾宽高比与特征密度，提升模型对遥感、无人机等不同视角的稳健性。
- **领域化对话模板**：结合多轮对话模板和图像token占位符，使救援人员以自然语言完成风险询问、路径规划与资源调度。

### 3.3 主要技术方案
#### 3.3.1 图像预处理与分辨率匹配
- 使用自动填充与中心裁剪算法，将任意尺寸图像转换为网格化输入；
- 对超高分辨率图像按固定步长切片，保证细节不丢失；
- 通过候选分辨率筛选，兼顾有效像素与计算成本。

#### 3.3.2 实例感知与空间提示生成
- 加载预训练的实例检测模型，对输入图片生成边界框集合，并按原始尺寸归一化；
- 将坐标插入到用户问题中形成“at position [x1,y1,x2,y2]”提示，若用户未提供位置描述，则自动补全；
- 保存检测可视化结果以便事后校核。

#### 3.3.3 多模态大模型推理与对话
- 使用包含图像token（如`<image>`、`<im_start>`、`<im_end>`）的对话模板构建提示；
- 将编码后的图像特征与文本一并送入多模态大语言模型，生成包括总体风险评估、区域级隐患、撤离路线和物资建议的长文本；
- 支持多轮交互，前一轮的指令和模型答复将串接形成连续上下文。

#### 3.3.4 输出与应用
- 向终端输出结构化文本：风险等级、关键目标位置、行动建议列表；
- 可集成至应急指挥平台、无人机地面站或移动端应用，实现现场快速决策。

## 4. 具体实施方式（结合代码）
1. **模型加载与推理**：`demo.py`中调用`load_pretrained_model`加载大模型与图像处理器，接收用户问题与图片后生成回答。
2. **边界框生成**：`llmark/get_box.py`使用YOLO模型推理图片，得到归一化坐标并写入提示，实现空间感知增强。
3. **对话模板与图像token处理**：`llmark/conversation.py`提供多种分隔符样式与图像token处理逻辑，保障模型正确解析多模态输入。
4. **高分辨率处理工具**：`llmark/mm_utils.py`提供自动填充、分块提取与分辨率选择方法，确保大模型在大尺寸图像上保持有效感知。
5. **终端交互流程**：用户通过自然语言提出“整体洪涝风险及建议”问题，系统将图像预处理、检测补位、对话模板构建、推理生成等步骤串接，输出可执行救援建议。

## 5. 有益效果
- 相比仅依赖视觉检测的方案，本发明可直接输出可读的救援指导，减少人工分析时间；
- 通过空间提示融合提升了大模型回答的可验证性，避免“幻觉”位置描述；
- 高分辨率预处理与多轮对话能力使系统适用于复杂多变的灾害场景。

## 6. 权利要求书撰写要点（草案）
- 权利要求1：一种基于多模态大语言模型的洪涝灾害图像识别与救援建议生成方法，包括图像预处理、实例检测并生成边界框提示、构建含图像token的对话输入、执行多模态推理并输出救援文本。
- 权利要求2：根据权利要求1所述的方法，其中边界框坐标按原图尺寸归一化并自动插入用户问题，在缺省位置描述时自动补全。
- 权利要求3：根据权利要求1所述的方法，其中图像预处理包含自动填充、中心裁剪及固定步长切片，以适配多尺度输入。
- 权利要求4：根据权利要求1所述的方法，其中多模态大语言模型使用包含图像token的对话模板，支持多轮上下文关联。
- 权利要求5：一种实现权利要求1-4任一方法的系统，包括图像处理模块、实例感知模块、提示生成模块、多模态推理模块与交互展示模块。

## 7. 可能的附图（可选）
- 系统总体框架示意图：展示图像流、检测模块、大模型推理模块与终端的交互。
- 核心流程图：显示预处理—检测—提示生成—多模态推理—文本输出的顺序。
- 示例界面：标注检测框的灾害图片及对应的救援建议文本。

## 8. 可扩展性与部署
- 模型与权重支持本地化部署，满足应急场景下的离线需求；
- 实例检测模型和大语言模型可替换为更高精度版本，同时保留提示融合机制；
- 可接入无人机或固定摄像头实时流，实现在线洪涝监控与自动预警。
